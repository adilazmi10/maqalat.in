<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://npnjpcwqmfwwviqlwrvw.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbmpwY3dxbWZ3d3ZpcWx3cnZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTMyMzMsImV4cCI6MjA2ODY4OTIzM30.EEbXf-xsonUjvE0DZBOGcG9EU97aGNSUc6MRTEE40pU';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const articleId = new URLSearchParams(window.location.search).get('id');
  const numericId = Number(articleId); // ✔ FIXED

  async function loadArticle() {
    if (!numericId) return;

    const { data: article, error } = await supabase
      .from('articles')
      .select('id, title, reference, content, author_id, authors(name), created_at')
      .eq('id', numericId)   // ✔ FIXED
      .single();

    if (error || !article) {
      document.getElementById('bookContainer').innerHTML = '<p>مضمون نہیں ملا۔</p>';
      return;
    }

    document.getElementById('title').textContent = article.title;
    document.getElementById('reference').textContent = article.reference || '';
    document.getElementById('author-link').textContent = article.authors?.name || 'نامعلوم';
    document.getElementById('author-link').href = `author.html?id=${article.author_id}`;

    const chunks = (article.content || '').match(/(.|[\r\n]){1,1000}/g) || [];
    const container = document.getElementById('bookContainer');
    container.innerHTML = '';

    chunks.forEach((chunk, index) => {
      const page = document.createElement('div');
      page.className = 'book-page';
      page.innerHTML = chunk + `<div class="page-number">صفحہ ${index + 1}</div>`;
      container.appendChild(page);
    });

    loadRelated(article.author_id, article.id);
  }

  async function loadRelated(authorId, currentId) {
    const { data, error } = await supabase
      .from('articles')
      .select('id, title, created_at')
      .eq('author_id', authorId)
      .order('created_at', { ascending: true });

    if (error || !data) return;

    const index = data.findIndex(a => a.id == currentId);
    const prev = data[index - 1];
    const next = data[index + 1];

    const footer = document.getElementById('relatedLinks');
    footer.innerHTML = `
      ${prev ? `<a href="article.html?id=${prev.id}">← پچھلا</a>` : ''}
      ${next ? `<a href="article.html?id=${next.id}">اگلا →</a>` : ''}
    `;
  }

  document.addEventListener('DOMContentLoaded', loadArticle);
</script>

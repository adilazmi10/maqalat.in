<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://npnjpcwqmfwwviqlwrvw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbmpwY3dxbWZ3d3ZpcWx3cnZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTMyMzMsImV4cCI6MjA2ODY4OTIzM30.EEbXf-xsonUjvE0DZBOGcG9EU97aGNSUc6MRTEE40pU"
);

const articleId = new URLSearchParams(window.location.search).get("id");

async function loadArticle() {
  if (!articleId) {
    document.getElementById("bookContainer").innerHTML = "آرٹیکل ID موجود نہیں";
    return;
  }

  const { data: article, error } = await supabase
    .from("articles")
    .select(`
      id,
      title,
      reference,
      content,
      author_id,
      created_at,
      authors(name, bio)
    `)
    .eq("id", articleId)
    .single();

  if (error || !article) {
    console.error("Supabase error:", error);
    document.getElementById("bookContainer").innerHTML = "مضمون نہیں ملا۔";
    return;
  }

  document.getElementById("title").textContent = article.title;
  document.getElementById("reference").textContent = article.reference || "";
  document.getElementById("author-link").textContent = article.authors?.name || "نامعلوم";
  document.getElementById("author-link").href = `author.html?id=${article.author_id}`;

  const chunks = (article.content || "").match(/(.|[\r\n]){1,1000}/g) || [];
  const container = document.getElementById("bookContainer");
  container.innerHTML = "";

  chunks.forEach((chunk, index) => {
    const page = document.createElement("div");
    page.className = "book-page";
    page.innerHTML = chunk + `<div class="page-number">صفحہ ${index + 1}</div>`;
    container.appendChild(page);
  });

  loadRelated(article.author_id, article.id);
}

async function loadRelated(authorId, currentId) {
  const { data } = await supabase
    .from("articles")
    .select("id, title, created_at")
    .eq("author_id", authorId)
    .order("created_at");

  if (!data) return;

  const index = data.findIndex(a => a.id == currentId);
  const prev = data[index - 1];
  const next = data[index + 1];

  document.getElementById("relatedLinks").innerHTML = `
    ${prev ? `<a href="article.html?id=${prev.id}">← پچھلا</a>` : ""}
    ${next ? `<a href="article.html?id=${next.id}">اگلا →</a>` : ""}
  `;
}

loadArticle();
</script>
